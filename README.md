# K42-Project-Template
This is a 'minimum buildable' project using the full set of PIC18FxxK42 libraries.

This template is effectively the same as entering the following commands in an empty folder:

```shell
git init
git submodule add https://github.com/DaelonSuzuka/K42-Peripheral-Libraries src/peripherals
git submodule add https://github.com/DaelonSuzuka/K42-System-Libraries src/peripherals
git submodule add https://github.com/DaelonSuzuka/Easy-XC8.git toolchain
python toolchain/install.py
make config
```

# Project skeleton
A small selection of example files are included. 

- `Makefile`, generated with the toolchain's install script
- `project.yaml`, generated with the toolchain's config wizard(`make config`)
- `cogfiles.txt`, the list of files to be processed by `make cog`
- `pins.csv`, this file defines all the pin settings, see [Pin Configuration](#-Pin-Configuration)
- `src/main.c`, 
- `src/config.h`, a reasonable collection of configuration bit settings
- `src/pins.c`, see [Pin Configuration](#-Pin-Configuration)
- `src/pins.h`, see [Pin Configuration](#-Pin-Configuration)
- `src/system.c`, 
- `src/system.h`, 

# Startup
TODO: Walk through `startup()` and the proper sequencing of `xxxx_init()`s.

# Pin Configuration
Pin configuration code in `src/pins.c` and `src/pins.h` is generated by embedded blocks of python code, powered by [Ned Batchelder's Cog](https://nedbatchelder.com/code/cog/). The actual code generation is handled [here](https://github.com/DaelonSuzuka/CodeGen/blob/master/codegen/pins.py).

Pin configurations are defined in `pins.csv`. The example code has two pins defined:

```
B0, DEBUG_TX_PIN, output pps
B1, DEBUG_RX_PIN, input pps
```

This causes the following code to be generated in `pins.c`:
```c
// GPIO read functions
// none

// GPIO write functions
// none

void pins_init(void) {
  // DEBUG_TX_PIN
  TRISBbits.TRISB0 = 0;

  // DEBUG_RX_PIN
  TRISBbits.TRISB1 = 1;
}
```
And the following code to be generated in `pins.h`:
```c
// GPIO read functions
// none

// GPIO write functions
// none

// PPS initialization macros
#define PPS_DEBUG_TX_PIN PPS_OUTPUT(B, 0)
#define PPS_DEBUG_RX_PIN PPS_INPUT(B, 1)

// ADC Channel Select macros
// none
```

These PPS initialization macros are then used in `system.c` to configure a UART for the serial port:
```c
uart_config_t config = UART_get_config(2);
config.baud = _115200;
config.txPin = PPS_DEBUG_TX_PIN;
config.rxPin = PPS_DEBUG_RX_PIN;
serial_port_init(UART_init(config));
```

TODO: instructions for adding your own pins